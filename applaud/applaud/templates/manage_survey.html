{% extends "business.html" %}
{% block title %}Create survey{% endblock %}
{% block links %}
<link href="http://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css">
{% endblock %}
{% block scripts %}
<script rel="javascript" type="text/javascript" src="{{ STATIC_URL }}jquery.js"></script>
<script type="text/javascript">

var questionTypes = {"CG":"checkbox group",
		     "RG":"radio group",
		     "TA":"textarea",
		     "TF":"textfield"};

function renderSurvey( data ) {
    var survey = data.survey;
    console.log("Title = "+survey['title']);
    $('#survey_title').val( survey.title );
    $('#survey_description').val( survey['description'] );
    
    for ( q in survey.questions ) {
	var question = survey.questions[q];
	
	addQuestion( question.label,
		     question.type,
		     question.options,
		     question.active );
    }
}

// Keeps track of # of questions
var i = 0;

// Start off with question 0 has 1 option
var questionOptions = [1];

$(document).ready(function() {
    // Pull down the survey
    $.ajax( {
	url: '/business/business_manage_survey/',
	success: renderSurvey,
	data: {'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val()},
	type: 'POST',
	error: function() { alert("Something went wrong."); }
    });
    
    // Set up buttons
    $(".question_div").each( function(index, ele){
	console.log($(this).children(".question_option").length);
	questionOptions[index]=$(this).children(".question_option").length;
    });
    
    $(".question_div").click(function() {
	var qnum = $(this).prop('id').split('_')[1];
	console.log(qnum);
	addOption(qnum);
	
    });

    
    $("#addquestion").click(function() {
	addQuestion();
    });
});

function addQuestion( label, type, options, active ) {
    //Objects to instantiate:
    //1.Question label
    //2.Question type
    //3.Option field (e.g. first entry of a radio button)
    //4.Add option button

    var questionDiv = $("<div></div>");
    questionDiv.prop({'id':"question_"+i+"_div"});
    questionDiv.prop({'class':"question"});
    $("#submit_button").before(questionDiv);
    
    var questionAreaLabel = $("<label>Question #"+(i+1)+"</label>");
    questionAreaLabel.prop({"for":"question_"+i});
    
    var questionArea = $("<textarea></textarea>");
    questionArea.prop({'name':"question_"+i,
		       'id':"question_"+i});
    questionArea.text( label );
    
    var questionTypeLabel = $("<label>Question type </label>");
    questionTypeLabel.prop({"for":"question_"+i+"_type"});
    
    var questionType = $("<select></select>");
    questionType.prop({'name':"question_"+i+"_type",
		       'id':"question_"+i+"_type"});
    
    // Render question types, selecting the appropriate one by default
    for ( o in questionTypes ) {
	var optionWidget = $('<option value="'+o+'">'+questionTypes[o]+'</option>');
	if ( type === o ) {
	    optionWidget.prop({'selected':'selected'});
	}
	questionType.append( optionWidget );
    }
    
    // Create a new question bucket for storing # of options
    questionOptions.push(0);
    
    var optionDiv = $("<div></div>");
    optionDiv.prop({'id':"question_"+i+"_options",
		    'class':"question_option",
		   });
    
    // Render each of the options for the question
    for ( o in options ) {
	var optionLabel = $('<label>Option '+o+'</label>');
	optionLabel.prop({'for':'question_'+i+'_option_'+o});

	var optionWidget = $('<input />');
	optionWidget.prop({'type':'text',
			   'name':'question_'+i+'_option_'+o,
			   'class':'option_field'});
	
	optionDiv.append( optionLabel ).append( optionWidget );
    }
    
    // var questionNumber = i;
    // var addOptionButton = $("<button>Add Option</button>");
    // addOptionButton.prop({'type':"button",
    // 			    'name':"question_"+i+"_optionbutton",
    // 			    'id':"question_"+i+"_optionbutton"});
    // console.log("question number: "+questionNumber);
    // addOptionButton.click(function() {
    // 	  console.log("i is: "+i);
    //     $("#question_"+questionNumber+"_options").append(addOption(questionNumber));
    // });
    
    questionDiv
	.append(questionArea)
	.append("<br />")
	.append(questionAreaLabel)
	.append($("<br />"))
	.append(questionTypeLabel)
	.append(questionType)
	.append($("<br />"))
	.append(optionDiv);
    // .append($("<br />"))
    // .append(addOptionButton);
    console.log(i);
    addOption(i);
    i++;
}


function addOption(qindex) {
    var questionOptionsDiv = $("#question_"+qindex+"_options");
    
    var optionFieldLabel = $("<label>Option "+(questionOptions[qindex]+1)+"</label>");
    optionFieldLabel.prop({"for":"question_"+qindex+"_option_"+questionOptions[qindex]});

    var optionField = $("<input type=\"text\" class=\"question_option\" name=\"question_"+qindex+"_option_"+questionOptions[qindex]+"\" id=\"question_"+qindex+"_option_"+questionOptions[qindex]+"\"/><br />");
    console.log("qindex is :"+qindex);
    questionOptions[qindex]++;
    questionOptionsDiv
	.append(optionFieldLabel)
	.append(optionField);
}
</script>
{% endblock %}
{% block content %}
<h1>Create Survey</h1>
<div id="survey_div">

{% if title_err %}
<h2>{{ title_err }}</h2>
{% endif %}
{% if questions_err %}
<h2>{{ dimensions_err }}</h2>
{% endif %}
<form action="/survey_create/" method="post" id="survey_form">
  {% csrf_token %}
  
  Title:
  <input type="text" id="survey_title" name="title" />
  Description:
  <input type="text" id="survey_description" name="description" />

  <input type="submit" value="Create Survey" class="button" id="submit_button"/><br />
  <input type="submit" id="addquestion_button" value="Add Question" />
</form>
</div>




<!-- {% for item in list %} -->
<!-- <li>{{item.title}} -->
<!--   <ul> -->
<!-- 	{% for d in item.dimensions %} -->
<!-- 	<li>{{ d }} -->
<!-- 	{% endfor %} -->
<!--   </ul>  -->
<!-- {% endfor %} -->
<!-- </ul> -->

{% endblock %}
