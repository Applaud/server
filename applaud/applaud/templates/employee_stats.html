{% extends "employee.html" %}
{% block title %}Your Statistics{% endblock %}
{% block scripts %}
{{ block.super }}
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load("visualization", "1", {packages:["corechart"]});

/************************************************
 * Global variables used to construct the chart *
 ************************************************/
//Lists retrieved from the ajax call
var employees;
var dimensions;

//Lists who actually determine the composition of the chart
var cur_employees=[];
var cur_dimensions=[];

var cur_dim_titles=[];

//The first and last dates of ratings in cur_employees and cur_dimensions
var first;
var last;

//The first and last dates of ratings selected on the bar
var range_start;
var range_stop;

/*************************
 * CSS related variables *
 *************************/
var selected_background_color = "#bbbbbb";

// This function should take a list of dimensions, dimList, a list of employees, employeeList
// and two variables start & stop which should be datestrings (like in the ajax call)
// TODO: Include time range in this function
function make_chart() {
    // This is eventually the data fed into the chart
    var chart_list = [];
    
    // Build the axes
    var row0 = [ 'Dimension' ];
    for( d in cur_dimensions){
	row0.push(cur_dimensions[d].title)
    }
    
    chart_list.push(row0);

    // For each employee, calculate avg rating for each dimension
    for ( e in cur_employees ) {
	var avgRatings = [];
	var totalRatings = {};
	var employee = cur_employees[e];

	// Sum up totals for each dimension
	for ( r in employee.ratings ) {
	    if (! totalRatings[employee.ratings[r].title] ){
		totalRatings[employee.ratings[r].title] = [];
	    }
	    totalRatings[employee.ratings[r].title].push( employee.ratings[r].value );
	}
	console.log(totalRatings);
	// Compute averages
	for ( i in cur_dimensions ) {
	    var dimName = cur_dimensions[i].title;
	    avgRatings[i] = 0;
	    if ( dimName in totalRatings && totalRatings[dimName].length > 0 ) {
		var total = 0;
		for( r in totalRatings[dimName]) {
		    total += totalRatings[dimName][r];
		}
		avgRatings[i] = total / totalRatings[dimName].length;
	    }
	}

	var nextRow = [employee.first_name+' '+employee.last_name];
	nextRow = nextRow.concat(avgRatings);
	chart_list.push(nextRow);
    }

    // Create and populate the data table.
    var data = google.visualization.arrayToDataTable( chart_list );
    
    // Create and draw the visualization.
    new google.visualization.ColumnChart(document.getElementById('emp_graph')).
	draw(data,
             {title:"Evaluations by Dimension",
              width:700, height:400,
              hAxis: {title: "Dimension"},
              vAxis: {title: "Average Rating"}}
	    );
}

function dateToJS( date ) {
    // This assumes that we are getting dates in the format dd/mm/YYYY
    console.log("date is: "+date);
    var components = date.split('/');
    return new Date(components[2],components[1],components[0]);
}

// Compare two ratings based on the date they were submitted.
// rating1, rating2 = two ratings
function dateCompare( rating1, rating2 ) {
    return dateToJS(rating1.date) > dateToJS(rating2.date)? 1 : -1;
}

function buildTable() {
    
    var the_list = $('<ol></ol>');
    the_list.prop({'id':"dimension_list"});
    for (d in dimensions) {
	var dim = dimensions[d];
	var list_item = $('<li></li>');
	list_item.prop({'id':'dim_'+dim.title});
	list_item.text(dim.title);
	list_item.hover(dimension_hover_in, dimension_hover_out);
	list_item.click(dimension_click);
	the_list.append(list_item);
    }

    $('#gt_dims').append(the_list);
}

/**
 * filterRatings
 *
 * Filters the ratings displayed on the chart, given the min/max values
 * from the double-handled slider.
 */
function filterRatings( min, max ) {
    
}

//Builds a list of titles from the current dimensions
function buildDimensionTitles(){
    cur_dim_titles = []
    for ( d in cur_dimensions ){
	if(cur_dim_titles.indexOf(cur_dimensions[d].title)==-1){
	    cur_dim_titles.push(cur_dimensions[d].title);
	}
    }
}
// A function to be called whenever cur_dimensions or cur_employees is changed
// This will reset the slider, rebuild the rateable dimensions table, and perform
// any other necessary cleanup necessary
function refresh(){
    console.log("refresh getting called");
    buildDimensionTitles();
}

function sliderValueToString(sliderValue){
    // This function will take a value from the slider (an integer from 0-n) and convert this to a date using, the 'first' global
    // Convert days as an integer to miliseconds
    var milliSinceFirst =sliderValue*86400000;
    var firstAsDate = dateToJS(first);
    var newDate = new Date( firstAsDate.getTime() + milliSinceFirst );
    return newDate.toDateString();
}

// This function assumes that ratings for a given employee are sorted by date
//
// TODO: The dateSlider should have some way of indicating the current range selected
// this could be simply a label at every 'step', another box displaying the range,
// or another implementation
function buildDateSlider() {
    for( e in cur_employees ){
	var e_ratings = cur_employees[e].ratings;
	var e_ratings_length =  cur_employees[e].ratings.length;
	var e_first;
	var e_last;
	for( r in e_ratings){
	    if(cur_dim_titles.indexOf(e_ratings[r].title)!=-1){
		e_first = e_ratings[r].date;
		break;
	    }
	}

	for( var i = e_ratings_length-1; i>=0; i--){
	    if(cur_dim_titles.indexOf(e_ratings[i].title)!=-1){
		e_last = e_ratings[i].date;
		break;
	    }
	}
	// Check if first and last have been set yet
	if(typeof(first) === 'undefined' && typeof(last) === 'undefined'){
	    first = e_first;
	    last = e_last;
	}
	else {
	    // If not, determine whether a particular employees rating is the global first (last)
	    first = dateToJS(first) > dateToJS(e_first)? first : e_first;
	    last = dateToJS(last) > dateToJS(e_last)? last : e_last;
	}
    }
    console.log(last+" "+first);
    var range = dateRange(last,first);
    console.log("range :"+range);
    var slider = $('#gt_dateslider');
    slider.slider({ animate: true,
	            range: true,
		    min: 0,
		    max: range,
		    values:[0,range]
		  });

    // Setting up various events for the slider

    // TODO: Implement slidervalue to date
    // Also, it seems as if the jQuery ui value method is slightly broken.... maybe change this? Or look for alternative
    slider.bind( "slide", function(event, ui) {
	var firstAsString = sliderValueToString($(this).slider("values")[0]);
	var lastAsString = sliderValueToString($(this).slider("values")[1]);
	var range_as_text= firstAsString+" - "+lastAsString;
	$("#dateslider_label").text("Time range: "+range_as_text);

//	filterRatings(
    });
    
}

// This computes date range in milliseconds, using Unix epoch between date_1 and date_2
// It then converts this to days
var dateRange = function(date_1, date_2){
    console.log("in dateRange");
    var day1 = dateToJS(date_1);
    var day2 = dateToJS(date_2);
    var range = day1.getTime() - day2.getTime();
    // Convert ms to days
    range /= 86400000;
    return range;
}

var dimension_hover_in = function(){
    $(this).css('background-color', selected_background_color);
}
var dimension_hover_out = function(){
    if(!$(this).is(".selected")){
	$(this).css('background-color', '#ffffff');
    }
}

var dimension_click = function(){
    var dim_title = $(this).text();
    var dimension;
    
    for( i in dimensions){
	if( dimensions[i].title == dim_title ){
	    dimension = dimensions[i];
	    break;
	}
    }

    $(this).toggleClass('dim_selected');
    
    if( $(this).is('dim_selected') ){
	add_dimension(dimension);
	$(this).css('background-color',selected_background_color);
    }
    else {
	remove_dimension(dimension);
    	$(this).css('background-color',"#ffffff");
    }
}

var employee_click = function(){
    // TODO: Determine the structure of the html when there are multiple employees
    // From this, we should grab the id.
    var emp_id = $(this).attr('id');
    var employee;
    
    //Is there a better (faster) way to do this?
    for( i in employees ){
	if( employees[i].id == emp_id ){
	    employee = employees[i];
	    break;
	}
    }

    $(this).toggleClass('selected');
    
    if( $(this).is('selected') ){
	add_employee(employee);
	$(this).css('background-color',selected_background_color);
    }
    else {
	remove_employee(employee);
    }
}


// Takes an employee JSON object of the form passed from the view
var add_employee = function(employee){
    //First, make sure the employee isn't in the chart
    var arr_index = cur_employees.indexOf(employee);
    if( arr_index === -1 ) cur_employees.push(employee); 

    make_chart();
}
// Takes an employee JSON object of the form passed from the view
var remove_employee = function(employee){
    var arr_index = cur_employees.indexOf(emp_id);
    if( arr_index != -1 ) cur_employees.splice(arr_index, 1); 
    
    make_chart();
}
// Takes a dimension JSON object of the form passed from the view
var add_dimension = function(dimension){
    console.log("adding dimension");
    //First, make sure the employee isn't in the chart
    var arr_index = cur_dimensions.indexOf(dimension);
    if( arr_index === -1 ) cur_dimensions.push(dimension); 

    make_chart();
}
// Takes a dimension JSON object of the form passed from the view
var remove_dimension = function(dimension){
    var arr_index = cur_dimensions.indexOf(dimension);
    if( arr_index != -1 ) cur_dimensions.splice(arr_index, 1); 
    
    make_chart();
}

$(document).ready( function() {

    $.ajax({url:"{% url employee_stats %}",
	    type:'POST',
	    data:{'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val()},
	    success:function(data) {
		employees = data.data.employees;
		dimensions = data.data.dimensions;
		cur_dimensions = dimensions;
		cur_employees = employees;
		refresh();
		make_chart();

		buildTable();
		buildDateSlider();
		
		var emp_id = employees[0].id;
		console.log("Employee id is: "+emp_id);
		apatapa.employee.getEmployee(emp_id, $("#employee_welcome"), function(){
		    
		});

	    },
	    error:function(){alert("Something went wrong.");}});


});
</script>
{% endblock %}
{% block links %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}employee_stats.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}employee.css" />
{% endblock %}
{% block content %}

<div id="employee_welcome"></div>

<div id="graph_table">
    <div id="gt_dims"></div>
    <div id="emp_graph"></div>
    <div id="date_slider_text">
    </div>
    <p id="dateslider_label"></p>
    <div id="gt_dateslider" name="dateslider"></div>
</div>
<form>
{% csrf_token %}
</form>

{% endblock %}
